

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Monitoring hosts &mdash; Sensu Go Ansible Collection  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Roles" href="../roles.html" />
    <link rel="prev" title="Managing Sensu Go Resources" href="managing_resources.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Sensu Go Ansible Collection
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Using Sensu Go Ansible Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Scenario guides</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../scenarios.html">Scenario guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installing_backend.html">Installing Sensu Go Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="managing_resources.html">Managing Sensu Go Resources</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Monitoring hosts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-the-inventory-file">Building the inventory file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparing-the-playbook">Preparing the playbook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#executing-the-playbook">Executing the playbook</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../roles.html">Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Hacker's guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hacking.html">Developing Sensu Go Ansible Collection</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sensu Go Ansible Collection</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../scenarios.html">Scenario guides</a> &raquo;</li>
        
      <li>Monitoring hosts</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/sensu/sensu-go-ansible/blob/master/docs/source/scenarios/monitoring_hosts.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="monitoring-hosts">
<h1>Monitoring hosts<a class="headerlink" href="#monitoring-hosts" title="Permalink to this headline">¶</a></h1>
<p>Once we have our Sensu Go backend ready, we can start installing agents on the
hosts that we would like to monitor. We will once again do this in three
stages. We will:</p>
<ol class="arabic simple">
<li><p>populate the inventory,</p></li>
<li><p>create the playbook, and</p></li>
<li><p>execute the playbook.</p></li>
</ol>
<p>Let us start with the Ansible inventory construction.</p>
<div class="section" id="building-the-inventory-file">
<h2>Building the inventory file<a class="headerlink" href="#building-the-inventory-file" title="Permalink to this headline">¶</a></h2>
<p>We will expand the inventory file from the Installing Sensu Go Backend
document. Reasons for this will become apparent once we get to the playbook
section. We will add a new group called <em>agents</em> and populate it with two
hosts that we would like to monitor. Once we get everything right, the
inventory should look like
<a class="reference download internal" download="" href="../_downloads/c45381abd37bd8b89eb7e8e47030869e/inventory.yaml"><code class="xref download docutils literal notranslate"><span class="pre">this</span></code></a>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">all</span><span class="p">:</span>
  <span class="nt">children</span><span class="p">:</span>
    <span class="nt">backends</span><span class="p">:</span>
      <span class="nt">hosts</span><span class="p">:</span>
        <span class="nt">192.168.50.4</span><span class="p">:</span>
          <span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vagrant</span>
    <span class="nt">agents</span><span class="p">:</span>
      <span class="nt">hosts</span><span class="p">:</span>
        <span class="nt">192.168.50.10</span><span class="p">:</span>
          <span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vagrant</span>
          <span class="nt">subscriptions</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">proxy</span>
        <span class="nt">192.168.50.11</span><span class="p">:</span>
          <span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vagrant</span>
          <span class="nt">subscriptions</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">linux</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">compute</span>
</pre></div>
</div>
<p>You probably noticed that we have a <em>subscriptions</em> variable defined for each
host. This host variable will allow us to use a single playbook to install
agents on different hosts with different configurations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are using a YAML inventory format in this document. Feel free to use any
other Ansible-supported form if this one does not feel right to you.</p>
</div>
<p>Now we can move on and start preparing the playbook.</p>
</div>
<div class="section" id="preparing-the-playbook">
<h2>Preparing the playbook<a class="headerlink" href="#preparing-the-playbook" title="Permalink to this headline">¶</a></h2>
<p>All we need to do in the playbook is to set some variables and call the
<em>sensu.sensu_go.agent</em> role. The initial version of the playbook would look
something like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install, configure and run Sensu agent</span>
  <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agents</span>
  <span class="nt">become</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

  <span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install agent</span>
      <span class="nt">include_role</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sensu.sensu_go.agent</span>
</pre></div>
</div>
<p>And while this playbook is fully functional as it is, we can make it a bit
safer by pinning down the version number. Another thing that we will do is to
replace the default configuration options for the agent with our own. After we
implement those changes, we end up with
<a class="reference download internal" download="" href="../_downloads/b76fa7eb1cba1d17e1da664d77a315e3/playbook.yaml"><code class="xref download docutils literal notranslate"><span class="pre">this</span></code></a>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install, configure and run Sensu agent</span>
  <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agents</span>
  <span class="nt">become</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

  <span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install agent</span>
      <span class="nt">include_role</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sensu.sensu_go.agent</span>
      <span class="nt">vars</span><span class="p">:</span>
        <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5.16.1</span>
        <span class="nt">agent_config</span><span class="p">:</span>
          <span class="nt">deregister</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">keepalive-interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="nt">keepalive-warning-timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">subscriptions</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">subscriptions</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>The <em>subscriptions</em> variable that we used in the <em>agent_config</em> comes from the
inventory and allows us to tweak the configuration of each agent
independently.</p>
<p>Another thing that the more observant of you might notice is the lack of any
information about the backend. We were able to omit it because we have a
backend group defined in the inventory. In cases like this, the agent role
knows how to construct the <em>backend-url</em> configuration option and
automatically insert it into the configuration.</p>
<p>We can override the default behavior by manually specifying the <em>backend-url</em>
configuration option in the <em>agent_config</em>. The agent role will stop being
smart in this case and use the value we provided.</p>
<p>And now, we are ready to execute the playbook.</p>
</div>
<div class="section" id="executing-the-playbook">
<h2>Executing the playbook<a class="headerlink" href="#executing-the-playbook" title="Permalink to this headline">¶</a></h2>
<p>We are just one command away from having a fully-functioning monitoring setup
up and running. And the magic Ansible command is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-playbook -i inventory.yaml playbook.yaml
</pre></div>
</div>
<p>If everything went according to plan, we should be able to see the two new
entities in the Sensu Go dashboard. We can now pat ourselves on the back and
call it a day ;)</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../roles.html" class="btn btn-neutral float-right" title="Roles" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="managing_resources.html" class="btn btn-neutral float-left" title="Managing Sensu Go Resources" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, XLAB Steampunk

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>