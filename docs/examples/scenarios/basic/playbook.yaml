---
- name: Install, configure and run Sensu backend
  hosts: backends
  become: true

  tasks:
    - name: Install backend
      include_role:
        name: sensu.sensu_go.backend
      vars:
        version: 5.16.1
        cluster_admin_username: tadej
        cluster_admin_password: my.password  # USE VAULT IN REAL SCENARIOS!!!
        backend_config:
          log-level: info


- name: Install, configure and run Sensu agent
  hosts: agents
  become: true

  tasks:
    - name: Install agent
      include_role:
        name: sensu.sensu_go.agent
      vars:
        version: 5.16.1
        agent_config:
          deregister: true
          keepalive-interval: 5
          keepalive-warning-timeout: 10
          subscriptions: "{{ subscriptions }}"

- name: Manage Sensu Go resources
  hosts: localhost
  gather_facts: false
  collections: [ sensu.sensu_go ]

  tasks:
    - name: Create monitoring asset
      bonsai_asset:
        auth: &auth
          user: tadej
          password: my.password  # DO NOT DO THIS IN REAL SCENARIOS!!!
          url: http://192.168.50.20:8080
        name: sensu/monitoring-plugins
        version: 2.3.0-1

    - name: Create ntp check
      check:
        auth: *auth
        name: ntp
        runtime_assets: sensu/monitoring-plugins
        command: check_ntp_time -H time.nist.gov --warn 0.5 --critical 1.0
        output_metric_format: nagios_perfdata
        publish: true 
        interval: 30
        timeout: 10
        subscriptions: 
          - linux
