<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Testing Sensu Go Ansible Collection &mdash; Sensu Go Ansible Collection  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Preparing docker images for integration tests" href="docker-images.html" />
    <link rel="prev" title="Preparing a development environment" href="setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Sensu Go Ansible Collection
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Using Sensu Go Ansible Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-sensu-go-6.html">Quickstart for Sensu Go 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-sensu-go-5.html">Quickstart for Sensu Go 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../versioning_sensu_go_installation.html">Versioning Sensu Go installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensu_go_5_6_migration.html">Updating playbooks for Sensu Go 6</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../roles.html">Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hacker's guides</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../hacking.html">Developing Sensu Go Ansible Collection</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="setup.html">Preparing a development environment</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Testing Sensu Go Ansible Collection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#static-analysis">Static analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unit-tests">Unit tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integration-tests">Integration tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#continuous-integration">Continuous integration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="docker-images.html">Preparing docker images for integration tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="documentation.html">Documenting Sensu Go Ansible collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="windows.html">Windows things</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases.html">Releasing the Sensu Go Ansible Collection</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../release_policy.html">Release policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sensu Go Ansible Collection</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../hacking.html">Developing Sensu Go Ansible Collection</a> &raquo;</li>
      <li>Testing Sensu Go Ansible Collection</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/sensu/sensu-go-ansible/blob/master/docs/source/hacking/testing.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="testing-sensu-go-ansible-collection">
<h1>Testing Sensu Go Ansible Collection<a class="headerlink" href="#testing-sensu-go-ansible-collection" title="Permalink to this headline"></a></h1>
<p>Sensu Go Ansible collection contains a comprehensive test suite. We use this
test suite to make sure collection’s source code</p>
<ol class="arabic simple">
<li><p>meets the Ansible code quality standards,</p></li>
<li><p>works with supported versions of Ansible,</p></li>
<li><p>works with supported versions of Sensu Go, and</p></li>
<li><p>works with supported versions of Python.</p></li>
</ol>
<section id="static-analysis">
<h2>Static analysis<a class="headerlink" href="#static-analysis" title="Permalink to this headline"></a></h2>
<p>We use a wide variety of linters and static code analysis tools to ensure our
code base stays healthy. To run all checks, we can execute the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ make sanity
</pre></div>
</div>
<p>This command will take care of installing requirements and running them.</p>
<p>The tools we use are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">flake8</span></code> for making sure our python code is nice and tidy.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible-lint</span></code> to make sure our Ansible roles follow the best practices.</p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ansible-test</span> <span class="pre">sanity</span></code> for ensuring our modules and plugins will work on a</dt><dd><p>wide varienty of platforms.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>A custom script that makes sure roles metadata is in sync with Ansible</dt><dd><p>Galaxy.</p>
</dd>
</dl>
</li>
</ol>
</div></blockquote>
</section>
<section id="unit-tests">
<h2>Unit tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline"></a></h2>
<p>We use unit tests to test the logic and implementation of our helper functions
and various Ansible plugins that are part of the Sensu Go collection.</p>
<p>Unit tests live in the <code class="docutils literal notranslate"><span class="pre">tests/unit</span></code> directory and mirror the structure of
the code. For example, unit tests for the code in the
<code class="docutils literal notranslate"><span class="pre">plugins/modules/asset.py</span></code> are stored in the
<code class="docutils literal notranslate"><span class="pre">tests/unit/plugins/modules/test_asset.py</span></code> file. When we add new code to the
collection, we must also include the tests for this piece of code in the same
git commit.</p>
<p>We group our tests using classes. Each function or method gets its own
dedicated test class that contains one or more tests that check different
aspects of the code under scrutiny.</p>
<p>We use <code class="docutils literal notranslate"><span class="pre">ansible-test</span> <span class="pre">units</span></code> to execute the unit tests. But we can also
execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ make units
</pre></div>
</div>
<p>to run them. This convenience <code class="docutils literal notranslate"><span class="pre">make</span></code> rule will all of our unit tests in a
dedicated docker container againts all Python versions that Ansible supports on
managed nodes. Additionally, it will also generate a code coverage report and
place it in the <code class="docutils literal notranslate"><span class="pre">tests/output/reports/coverage/index.html</span></code> HTML file.</p>
<p>Our CI process runs unit tests on each push to GitHub. And while developers
usually run the tests only against one version of Ansible, CI tools run them
against all supported versions, making sure our code is ready to be used on a
variety of systems.</p>
</section>
<section id="integration-tests">
<h2>Integration tests<a class="headerlink" href="#integration-tests" title="Permalink to this headline"></a></h2>
<p>Integration tests are basically a collection of Ansible playbooks that we run
against all supported Sensu Go versions and operating systems. Integration
tests live in the <code class="docutils literal notranslate"><span class="pre">tests/integration/molecule</span></code> directory. We use <a class="reference external" href="https://molecule.readthedocs.io/en/stable/">Molecule</a>
to manage our integration tests.</p>
<p>We can add a new test scenario by creating a suitably named directory and
populating it with a <code class="docutils literal notranslate"><span class="pre">playbook.yml</span></code> playbook and <code class="docutils literal notranslate"><span class="pre">molecule.yml</span></code>
configuration file.</p>
<p>If we are creating an integration test for a module, we can leave the molecule
configuration file empty. But we must still create the configuration file, or
Molecule will not detect this scenario. For example, if we would like to
create a new Molecule scenario that is testing the <code class="docutils literal notranslate"><span class="pre">asset</span></code> module, we would
run this sequence of commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ mkdir tests/integration/molecule/module_asset
(venv) $ touch tests/integration/molecule/module_asset/{molecule,playbook}.yml
</pre></div>
</div>
<p>Now we need to add some content to the playbook we just created. There are
plenty of examples in our test directory if you need some inspiration ;)</p>
<p>Once we have our playbook ready, we can test our scenario by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ make tests/integration/molecule/module_asset
</pre></div>
</div>
<p>We can also run all integration tests with a single command:</p>
<blockquote>
<div><p>(venv) $ make integration</p>
</div></blockquote>
<p>Do note that this will take about an hour or so, so make sure you have
something else to do in the mean time ;)</p>
<p>Adding a scenario for role is a bit more complicated since we need to inform
Molecule what docker images it should use for running tests, but nothing
drastic.</p>
<p>We run our integration tests as part of our CI process, further reducing the
chances of broken code getting into our repository.</p>
</section>
<section id="continuous-integration">
<h2>Continuous integration<a class="headerlink" href="#continuous-integration" title="Permalink to this headline"></a></h2>
<p>We use CircleCI to run our test suite on each push and pull request. Our CI
pipeline is composed of two stages: a fast one and a slow one.</p>
<p>The fast stage is composed of sanity and unit tests. Once those tests are done
executing and passing, we start execution of the slow stage that runs
integration tests.</p>
<p>In order to keep the test times as short as possible, the slow stage is
parallelized. And in order to maximize the benefits of this parallel
execution, we need to split the work into similarly sized chunks. This is done
automatically on CircleCI based on the timings from the previous runs.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="setup.html" class="btn btn-neutral float-left" title="Preparing a development environment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="docker-images.html" class="btn btn-neutral float-right" title="Preparing docker images for integration tests" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, XLAB Steampunk.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>